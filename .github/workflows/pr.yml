name: Main pull request workflow

# its a dev branch

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
  workflow_dispatch:

jobs:
  Init:
    runs-on: ubuntu-latest
    outputs:
      VERSION: ${{ steps.env_init.outputs.VERSION }}
      PACK_NAME: ${{ steps.env_init.outputs.PACK_NAME }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ENV init
        id: env_init
        run: |
          echo "VERSION=$(jq -r .version package.json)" >> $GITHUB_OUTPUT
          echo "PACK_NAME=$(jq -r .name package.json)" >> $GITHUB_OUTPUT

      - name: Branch Protection
        env:
          GH_TOKEN: ${{ secrets.ACCESS_PAT }}
          REPO: ${{ github.repository }}
        run: |
          echo '{
            "required_linear_history": true,
            "enforce_admins": true,
            "required_pull_request_reviews": null,
            "restrictions": null,
            "required_status_checks": {
              "strict": true,
              "contexts": ["Build-and-Test"]
            }
          }' | gh api -X PUT /repos/$REPO/branches/main/protection \
            -H "Accept: application/vnd.github.v3+json" \
            --input -

  Build-and-Test:
    needs: Init
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and Test Action
        uses: kirylzhan-stack/cicd-repo/.github/actions/build-and-test@main
        with:
          VERSION: ${{ needs.Init.outputs.VERSION }}

  E2E-Tests:
    runs-on: ubuntu-latest
    needs: [Build-and-Test, Init]
    if: contains(github.event.pull_request.labels.*.name, 'verify')
    steps:
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: dev-${{ needs.Init.outputs.VERSION }}
          path: .

      - name: Set-Up local npm registry
        run: |
          cat <<EOF > verdaccio-config.yaml
          storage: ./verdaccio-storage
          auth:
            htpasswd:
              file: ./htpasswd
          packages:
            '**':
              access: \$all
              publish: \$all
          EOF
          npx verdaccio --config verdaccio-config.yaml --listen 4873 &
          npx wait-on http://localhost:4873

      - name: publish to local npm registry
        run: |
          npm config set registry http://localhost:4873
          npm config set //localhost:4873/:_authToken "dummy-token"
          npm publish

      - name: Run E2E Package Test
        env:
          PACK_NAME: ${{ needs.Init.outputs.PACK_NAME }}
        run: |
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è —Ç–≤–æ–µ–≥–æ –ø–∞–∫–µ—Ç–∞ –∏–∑ package.json (—á–µ—Ä–µ–∑ —É—Ç–∏–ª–∏—Ç—É jq)
          PKG_NAME=$(jq -r '.name' package.json)
          mkdir test
          cd test
          npm init -y
          npm pkg set type="module"
          npm install $PACK_NAME --registry http://localhost:4873
          cat <<EOF > test.js
          import { sparkStatus, tinyWin } from '$PACK_NAME';

          console.log('üîÑ Testing sparkStatus...');
          const status = sparkStatus('Alice', 'turbo');
          if (status !== 'Alice: shipping mode') {
            console.error('‚ùå E2E Failed: sparkStatus returned incorrect value ->', status);
            process.exit(1);
          }

          console.log('üîÑ Testing tinyWin...');
          const win = tinyWin(10);
          if (win !== 'big win') {
            console.error('‚ùå E2E Failed: tinyWin returned incorrect value ->', win);
            process.exit(1);
          }

          console.log('‚úÖ All E2E Consumer Tests Passed Successfully!');
          EOF
          node test.js
